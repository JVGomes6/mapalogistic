<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa Interativo Palotina - Tempo Real</title>
<!-- Meta tags para compartilhamento -->
<meta property="og:title" content="Mapa Interativo Palotina - Tempo Real">
<meta property="og:description" content="Mapa interativo sincronizado em tempo real para múltiplos usuários">
<meta property="og:image" content="https://i.imgur.com/mwZz8bw.jpeg">
<meta property="og:url" content="https://exemplo.github.io/mapa-palotina">
<meta name="description" content="Mapa interativo de Palotina com sincronização em tempo real para até 15 usuários">
<style>
  :root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #ffcc00;
    --text-color: #333;
    --bg-color: #f8f9fa;
    --card-bg: #ffffff;
    --shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #000;
    color: var(--text-color);
    height: 100vh;
    overflow: hidden;
    position: relative;
    user-select: none;
    transition: background-color 0.3s ease;
  }

  .dark-mode {
    --primary-color: #ecf0f1;
    --secondary-color: #3498db;
    --accent-color: #f39c12;
    --text-color: #ecf0f1;
    --bg-color: #34495e;
    --card-bg: #2c3e50;
    --shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .aviso {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--accent-color);
    color: #000;
    font-weight: bold;
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    z-index: 30;
    text-align: center;
    max-width: 90%;
    transition: all 0.3s ease;
  }

  .aviso:hover {
    transform: translateX(-50%) scale(1.02);
  }

  .info {
    position: fixed;
    top: 10px;
    right: 10px;
    background-color: var(--card-bg);
    padding: 12px 18px;
    border-radius: 12px;
    font-weight: bold;
    color: var(--text-color);
    font-size: 14px;
    z-index: 20;
    text-align: right;
    box-shadow: var(--shadow);
    min-width: 180px;
    transition: all 0.3s ease;
  }

  .info:hover {
    transform: translateY(-2px);
  }

  .status-conexao {
    position: fixed;
    top: 10px;
    left: 10px;
    background-color: var(--card-bg);
    padding: 8px 12px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 12px;
    z-index: 20;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-conexao.online {
    background-color: #27ae60;
    color: white;
  }

  .status-conexao.offline {
    background-color: #e74c3c;
    color: white;
  }

  .status-conexao.connecting {
    background-color: #f39c12;
    color: white;
  }

  .ponto-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: piscar 2s infinite;
  }

  .status-conexao.online .ponto-status {
    background-color: #2ecc71;
  }

  .status-conexao.offline .ponto-status {
    background-color: #e74c3c;
  }

  .status-conexao.connecting .ponto-status {
    background-color: #f39c12;
  }

  @keyframes piscar {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Container do mapa que preenche toda a tela */
  .mapa-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
  }

  .mapa-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center center;
    display: block;
    transition: all 2s ease;
  }

  /* Efeito de molhado na tela durante chuva */
  .mapa-img.molhado {
    filter: 
      brightness(0.85) 
      contrast(1.1)
      saturate(1.2);
  }

  .mapa-img.molhado-forte {
    filter: 
      brightness(0.75) 
      contrast(1.2)
      saturate(1.3)
      blur(0.3px);
  }

  .mapa-img.tempestade {
    filter: 
      brightness(0.6) 
      contrast(1.3)
      saturate(1.4)
      blur(0.5px);
    animation: tremorTempestade 0.3s infinite;
  }

  @keyframes tremorTempestade {
    0%, 100% { transform: translateX(0) translateY(0); }
    25% { transform: translateX(-1px) translateY(-1px); }
    50% { transform: translateX(1px) translateY(1px); }
    75% { transform: translateX(-1px) translateY(1px); }
  }

  /* CICLO DIA/NOITE MAIS CLARO */
  .ciclo-dia-noite {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, 
      rgba(0, 0, 0, 0) 0%,
      rgba(0, 0, 0, 0) 100%
    );
    z-index: 4;
    pointer-events: none;
    transition: all 2s ease;
    mix-blend-mode: multiply;
  }

  /* Madrugada (00h-05h) - Mais claro */
  .ciclo-dia-noite.madrugada {
    background: linear-gradient(to bottom, 
      rgba(20, 20, 40, 0.6) 0%,
      rgba(10, 10, 25, 0.7) 100%
    );
  }

  /* Amanhecer (05h-07h) - Mais claro */
  .ciclo-dia-noite.amanhecer {
    background: linear-gradient(to bottom, 
      rgba(255, 160, 40, 0.2) 0%,
      rgba(255, 100, 0, 0.15) 30%,
      rgba(40, 40, 120, 0.3) 70%,
      rgba(20, 20, 40, 0.5) 100%
    );
  }

  /* Manhã (07h-12h) - Mais claro */
  .ciclo-dia-noite.manha {
    background: linear-gradient(to bottom, 
      rgba(135, 206, 235, 0.08) 0%,
      rgba(255, 255, 255, 0.03) 30%,
      rgba(255, 255, 255, 0) 100%
    );
  }

  /* Tarde (12h-17h) - Mais claro */
  .ciclo-dia-noite.tarde {
    background: linear-gradient(to bottom, 
      rgba(255, 225, 0, 0.08) 0%,
      rgba(255, 255, 255, 0.02) 30%,
      rgba(255, 255, 255, 0) 100%
    );
  }

  /* Entardecer (17h-19h) - Mais claro */
  .ciclo-dia-noite.entardecer {
    background: linear-gradient(to bottom, 
      rgba(255, 100, 0, 0.3) 0%,
      rgba(255, 160, 40, 0.2) 20%,
      rgba(90, 20, 150, 0.4) 60%,
      rgba(40, 40, 120, 0.6) 100%
    );
  }

  /* Noite (19h-24h) - Mais claro */
  .ciclo-dia-noite.noite {
    background: linear-gradient(to bottom, 
      rgba(40, 40, 120, 0.5) 0%,
      rgba(20, 20, 40, 0.6) 50%,
      rgba(10, 10, 25, 0.7) 100%
    );
  }

  /* ESTRELAS MAIS REALISTAS */
  .estrelas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 3;
    pointer-events: none;
    opacity: 0;
    transition: opacity 3s ease;
  }

  .estrelas.visivel {
    opacity: 1;
  }

  .estrela {
    position: absolute;
    border-radius: 50%;
    animation: brilharEstrela 4s infinite;
    box-shadow: 0 0 4px 1px rgba(255, 255, 255, 0.8);
  }

  .estrela.azulada {
    background: radial-gradient(circle, #e6f3ff 0%, #b3d9ff 70%, transparent 100%);
    box-shadow: 
      0 0 6px 2px rgba(179, 217, 255, 0.6),
      0 0 12px 3px rgba(179, 217, 255, 0.3);
  }

  .estrela.amarelada {
    background: radial-gradient(circle, #fff9e6 0%, #ffeb99 70%, transparent 100%);
    box-shadow: 
      0 0 6px 2px rgba(255, 235, 153, 0.6),
      0 0 12px 3px rgba(255, 235, 153, 0.3);
  }

  .estrela.alaranjada {
    background: radial-gradient(circle, #ffe6cc 0%, #ffcc99 70%, transparent 100%);
    box-shadow: 
      0 0 6px 2px rgba(255, 204, 153, 0.6),
      0 0 12px 3px rgba(255, 204, 153, 0.3);
  }

  @keyframes brilharEstrela {
    0%, 100% { 
      opacity: 0.3; 
      transform: scale(1);
    }
    25% { 
      opacity: 0.8; 
      transform: scale(1.1);
    }
    50% { 
      opacity: 0.4; 
      transform: scale(0.9);
    }
    75% { 
      opacity: 0.9; 
      transform: scale(1.05);
    }
  }

  /* Lua para a noite - CORRIGIDO */
  .lua {
    position: fixed;
    top: 50px;
    left: 50px;
    width: 80px;
    height: 80px;
    background: radial-gradient(circle at 30% 30%, 
      #f8f8ff 0%, 
      #e6e6fa 20%, 
      #d3d3d3 50%, 
      #a9a9a9 100%);
    border-radius: 50%;
    box-shadow: 
      0 0 30px 8px rgba(248, 248, 255, 0.7),
      0 0 60px 20px rgba(211, 211, 211, 0.4),
      inset -10px -5px 15px 5px rgba(0, 0, 0, 0.2);
    z-index: 4;
    opacity: 0; /* Inicialmente invisível */
    transition: opacity 2s ease;
    animation: brilharLua 6s ease-in-out infinite;
  }

  .lua.visivel {
    opacity: 1; /* Torna visível quando tem a classe */
  }

  @keyframes brilharLua {
    0%, 100% { 
      transform: scale(1) rotate(0deg);
      box-shadow: 
        0 0 30px 8px rgba(248, 248, 255, 0.7),
        0 0 60px 20px rgba(211, 211, 211, 0.4);
    }
    50% { 
      transform: scale(1.05) rotate(2deg);
      box-shadow: 
        0 0 40px 12px rgba(248, 248, 255, 0.8),
        0 0 80px 30px rgba(211, 211, 211, 0.5);
    }
  }

  /* Efeito de escurecimento para clima - MAIS CLARO */
  .escurecer-tela {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0);
    z-index: 6;
    pointer-events: none;
    transition: all 1s ease;
    mix-blend-mode: multiply;
  }

  .escurecer-tela.nublado {
    background: rgba(0, 0, 0, 0.2);
  }

  .escurecer-tela.chuva-leve {
    background: rgba(0, 0, 0, 0.25);
  }

  .escurecer-tela.chuva-forte {
    background: rgba(0, 0, 0, 0.35);
  }

  .escurecer-tela.tempestade {
    background: rgba(0, 0, 0, 0.5);
    animation: pulsarTempestade 3s infinite;
  }

  @keyframes pulsarTempestade {
    0%, 100% { background: rgba(0, 0, 0, 0.5); }
    50% { background: rgba(0, 0, 0, 0.6); }
  }

  /* EFEITO DE GOTAS NA TELA - NOVO */
  .gotas-tela {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 8;
    pointer-events: none;
    opacity: 0;
    transition: opacity 1s ease;
  }

  .gotas-tela.visivel {
    opacity: 1;
  }

  .gota-tela {
    position: absolute;
    background: linear-gradient(to bottom, 
      rgba(255, 255, 255, 0.8) 0%,
      rgba(200, 220, 255, 0.6) 50%,
      transparent 100%);
    border-radius: 50% 50% 60% 40%;
    animation: escorrerTela linear forwards;
    transform-origin: top center;
  }

  @keyframes escorrerTela {
    0% { 
      transform: translateY(-10px) scale(0.8);
      opacity: 0;
    }
    10% { 
      opacity: 0.8;
    }
    90% { 
      opacity: 0.6;
    }
    100% { 
      transform: translateY(100vh) scale(1.2);
      opacity: 0;
    }
  }

  /* Menus menores e posicionados absolutamente */
  .menu {
    position: absolute;
    background-color: var(--card-bg);
    border-radius: 18px;
    padding: 5px 8px;
    box-shadow: var(--shadow);
    cursor: grab;
    font-weight: bold;
    color: var(--text-color);
    min-width: 100px;
    transition: all 0.3s;
    z-index: 15;
    border: 2px solid transparent;
    text-align: center;
    font-size: 11px;
    transform: translate(-50%, -50%);
    touch-action: none;
  }

  .menu:hover, .menu:focus {
    background-color: var(--secondary-color);
    color: white;
    transform: translate(-50%, -50%) scale(1.05);
    border-color: var(--accent-color);
    outline: none;
  }

  .menu.ativo {
    background-color: var(--secondary-color);
    color: white;
    border-color: var(--accent-color);
    z-index: 16;
  }

  .menu.arrastando {
    cursor: grabbing;
    opacity: 0.8;
    transform: translate(-50%, -50%) scale(1.1);
    z-index: 100;
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
  }

  .conteudo {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.4s ease, opacity 0.4s ease;
    margin-top: 5px;
    font-weight: normal;
    background-color: var(--card-bg);
    padding: 0 8px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    color: var(--text-color);
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    z-index: 17;
    font-size: 10px;
    pointer-events: none;
  }

  .menu.ativo .conteudo {
    max-height: 150px;
    opacity: 1;
    padding: 5px 8px;
    pointer-events: auto;
  }

  /* POSIÇÕES ABSOLUTAS */
  #saoCamilo { top: 25%; left: 35%; }
  #palmital { top: 30%; left: 40%; }
  #boaVista { top: 35%; left: 30%; }
  #altoSantaFe { top: 65%; left: 35%; }
  #maripa { top: 75%; left: 40%; }
  #cincoMil { top: 70%; left: 55%; }
  #vilaNice { top: 60%; left: 55%; }
  #vilaSantoAntonio { top: 40%; left: 60%; }
  #vilaLaSalle { top: 30%; left: 55%; }
  #vilaFloresta { top: 20%; left: 70%; }
  #esquinaProgresso { top: 25%; left: 45%; }
  #linhaPecuaria { top: 50%; left: 47%; }
  #linhaSaoCarlos { top: 55%; left: 20%; }

  /* ANIMAÇÕES CLIMÁTICAS MELHORADAS */
  .chuva, .nuvens, .sol, .neve, .tempestade {
    position: fixed;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
    top: 0;
    left: 0;
  }

  /* CHUVA MAIS REALISTA */
  .gota {
    position: absolute;
    background: linear-gradient(to bottom, 
      rgba(180, 200, 255, 0.9) 0%,
      rgba(120, 160, 255, 0.7) 50%,
      rgba(80, 120, 255, 0.5) 100%);
    animation: cairChuva linear infinite;
    border-radius: 50% 50% 60% 40% / 70% 70% 30% 30%;
    box-shadow: 
      0 0 2px 1px rgba(255, 255, 255, 0.3),
      inset 0 -2px 2px rgba(0, 0, 0, 0.2);
  }

  .gota.leve {
    width: 2px;
    height: 15px;
    animation-duration: 1.8s;
    filter: blur(0.3px);
  }

  .gota.forte {
    width: 3px;
    height: 22px;
    animation-duration: 1s;
    filter: blur(0.5px);
  }

  .gota.tempestade {
    width: 4px;
    height: 28px;
    animation-duration: 0.6s;
    background: linear-gradient(to bottom, 
      rgba(150, 180, 255, 0.9) 0%,
      rgba(100, 140, 255, 0.7) 50%,
      rgba(60, 100, 255, 0.5) 100%);
    filter: blur(0.8px);
  }

  @keyframes cairChuva {
    0% { 
      transform: translateY(-30px) translateX(-5px) rotate(10deg) scale(0.8); 
      opacity: 0; 
    }
    10% { 
      opacity: 0.9;
    }
    80% { 
      opacity: 0.7;
    }
    100% { 
      transform: translateY(100vh) translateX(15px) rotate(10deg) scale(1.2); 
      opacity: 0; 
    }
  }

  /* NUVENS MAIS REALISTAS */
  .nuvem {
    position: absolute;
    background: radial-gradient(circle at 30% 30%, 
      rgba(240, 240, 240, 0.9) 0%,
      rgba(200, 200, 200, 0.7) 40%,
      rgba(160, 160, 160, 0.5) 100%);
    border-radius: 50%;
    filter: blur(12px);
    animation: moverNuvem linear infinite;
    box-shadow: 
      0 0 20px 5px rgba(255, 255, 255, 0.1),
      inset 0 0 20px rgba(255, 255, 255, 0.2);
  }

  .nuvem.grossa {
    background: radial-gradient(circle at 20% 20%, 
      rgba(180, 180, 180, 0.9) 0%,
      rgba(140, 140, 140, 0.7) 40%,
      rgba(100, 100, 100, 0.6) 100%);
    filter: blur(15px);
  }

  .nuvem.leve {
    background: radial-gradient(circle at 40% 40%, 
      rgba(250, 250, 250, 0.8) 0%,
      rgba(220, 220, 220, 0.6) 40%,
      rgba(190, 190, 190, 0.4) 100%);
    filter: blur(8px);
  }

  @keyframes moverNuvem {
    0% { transform: translateX(-400px); }
    100% { transform: translateX(calc(100vw + 400px)); }
  }

  /* SOL MELHORADO */
  .sol {
    background: radial-gradient(circle, 
      rgba(255, 255, 200, 0.95) 0%,
      rgba(255, 255, 0, 0.8) 30%,
      rgba(255, 200, 0, 0) 70%);
    border-radius: 50%;
    width: 120px;
    height: 120px;
    top: 30px;
    right: 30px;
    animation: brilharSol 4s ease-in-out infinite;
    box-shadow: 
      0 0 50px 20px rgba(255, 255, 0, 0.6),
      0 0 100px 40px rgba(255, 200, 0, 0.4),
      0 0 150px 60px rgba(255, 150, 0, 0.2);
    z-index: 5;
    opacity: 0;
    transition: opacity 2s ease;
  }

  .sol.visivel {
    opacity: 1;
  }

  @keyframes brilharSol {
    0%, 100% { 
      transform: scale(1) rotate(0deg);
      box-shadow: 
        0 0 50px 20px rgba(255, 255, 0, 0.6),
        0 0 100px 40px rgba(255, 200, 0, 0.4),
        0 0 150px 60px rgba(255, 150, 0, 0.2);
    }
    50% { 
      transform: scale(1.1) rotate(5deg);
      box-shadow: 
        0 0 60px 25px rgba(255, 255, 0, 0.7),
        0 0 120px 50px rgba(255, 200, 0, 0.5),
        0 0 180px 70px rgba(255, 150, 0, 0.3);
    }
  }

  /* NEVE MELHORADA */
  .floco {
    position: absolute;
    background: radial-gradient(circle, 
      rgba(255, 255, 255, 0.9) 0%,
      rgba(240, 240, 255, 0.7) 50%,
      transparent 100%);
    border-radius: 50%;
    filter: blur(1px);
    animation: cairNeve linear infinite;
    box-shadow: 
      0 0 3px 1px rgba(255, 255, 255, 0.5),
      inset 0 0 2px rgba(255, 255, 255, 0.8);
  }

  @keyframes cairNeve {
    0% { 
      transform: translateY(-20px) translateX(0) rotate(0deg) scale(0.8); 
      opacity: 0; 
    }
    10% { 
      opacity: 0.9;
    }
    90% { 
      opacity: 0.7;
    }
    100% { 
      transform: translateY(100vh) translateX(40px) rotate(360deg) scale(1.2); 
      opacity: 0; 
    }
  }

  /* RAIOS PARA TEMPESTADE - MAIS REALISTAS */
  .raio {
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0);
    animation: raioFlash 0.3s ease-out;
    z-index: 7;
    pointer-events: none;
  }

  @keyframes raioFlash {
    0% { background: rgba(255, 255, 255, 0); }
    5% { background: rgba(255, 255, 255, 0.9); }
    10% { background: rgba(255, 255, 255, 0); }
    15% { background: rgba(255, 255, 255, 0.7); }
    20% { background: rgba(255, 255, 255, 0); }
    25% { background: rgba(200, 220, 255, 0.5); }
    30% { background: rgba(255, 255, 255, 0); }
    100% { background: rgba(255, 255, 255, 0); }
  }

  /* Controls e outros estilos permanecem iguais */
  .controls {
    position: fixed;
    bottom: 20px;
    left: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 25;
  }

  .btn {
    background-color: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    font-size: 16px;
    font-weight: bold;
  }

  .btn:hover, .btn:focus {
    background-color: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    outline: none;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }

  .btn.ativo {
    background-color: rgba(255, 204, 0, 0.8);
    color: #000;
  }

  /* Modo escuro para os botões */
  .dark-mode .btn {
    background-color: rgba(52, 73, 94, 0.15);
    color: #ecf0f1;
    border: 1px solid rgba(236, 240, 241, 0.2);
  }

  .dark-mode .btn:hover, .dark-mode .btn:focus {
    background-color: rgba(52, 73, 94, 0.25);
  }

  .dark-mode .btn.ativo {
    background-color: rgba(243, 156, 18, 0.8);
    color: #2c3e50;
  }

  /* BOLINHAS UMA EMBAIXO DA OUTRA NA LATERAL ESQUERDA */
  .bolinhas-container {
    position: fixed;
    top: 80px;
    left: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    z-index: 20;
    background: rgba(0, 0, 0, 0.3);
    padding: 10px;
    border-radius: 10px;
    backdrop-filter: blur(5px);
  }

  .bolinha {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 20px;
    color: white;
    cursor: grab;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    user-select: none;
    position: relative;
    z-index: 20;
    border: 2px solid white;
  }

  .bolinha:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 18px rgba(0,0,0,0.4);
  }

  .bolinha.arrastando {
    cursor: grabbing;
    opacity: 0.7;
    z-index: 100;
  }

  /* Estilo para bolinhas livres pelo site */
  .bolinha-wrapper {
    position: fixed;
    z-index: 21;
    cursor: grab;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    transition: transform 0.2s ease;
  }

  .bolinha-wrapper:hover {
    transform: scale(1.05);
  }

  .bolinha-wrapper.arrastando {
    cursor: grabbing;
    opacity: 0.8;
    transform: scale(1.1);
    z-index: 100;
  }

  .bolinha.livre {
    position: relative;
    margin: 0;
  }

  .bolinha-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 5px 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    min-width: 80px;
    max-width: 150px;
  }

  .horario-input, .nome-input {
    border: none;
    background: transparent;
    text-align: center;
    font-size: 11px;
    font-weight: bold;
    color: #333;
    outline: none;
    width: 100%;
    padding: 2px 4px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }

  .horario-input {
    font-family: monospace;
    border-bottom: 1px dashed #ccc;
  }

  .nome-input {
    font-weight: normal;
    min-height: 16px;
    resize: none;
    overflow: hidden;
    line-height: 1.2;
  }

  .horario-input:focus, .nome-input:focus {
    background: rgba(52, 152, 219, 0.1);
  }

  .horario-input::placeholder, .nome-input::placeholder {
    color: #999;
    font-style: italic;
  }

  .bolinha.verde {
    background-color: #27ae60;
  }

  .bolinha.azul {
    background-color: #3498db;
  }

  .bolinha.vermelha {
    background-color: #e74c3c;
  }

  .bolinha-original {
    position: relative;
  }

  .bolinha-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
    color: white;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    outline: none;
    border-radius: 50%;
    display: none;
  }

  .bolinha.editando .bolinha-input {
    display: block;
  }

  .bolinha.editando .bolinha-texto {
    display: none;
  }

  /* Indicador visual de que é arrastável */
  .bolinha-original::after {
    content: '⇄';
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .bolinha-original:hover::after {
    opacity: 1;
  }

  /* Botão de exclusão para bolinhas livres */
  .bolinha-wrapper .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 20px;
    height: 20px;
    background: #e74c3c;
    border-radius: 50%;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 22;
    color: white;
    border: 2px solid white;
    pointer-events: auto;
  }

  .bolinha-wrapper:hover .delete-btn {
    opacity: 1;
  }

  /* Ajustes para modo tela cheia */
  body:fullscreen .mapa-container,
  body:-webkit-full-screen .mapa-container,
  body:-moz-full-screen .mapa-container {
    width: 100vw;
    height: 100vh;
  }

  body:fullscreen .mapa-img,
  body:-webkit-full-screen .mapa-img,
  body:-moz-full-screen .mapa-img {
    object-fit: contain;
  }

  /* Modal de compartilhamento */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 15px;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
  }

  .modal h3 {
    margin-bottom: 15px;
    color: var(--text-color);
  }

  .share-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin: 15px 0;
  }

  .share-btn {
    flex: 1;
    min-width: 120px;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
  }

  .share-btn.whatsapp { background: #25D366; color: white; }
  .share-btn.email { background: #EA4335; color: white; }
  .share-btn.link { background: #4285F4; color: white; }
  .share-btn.copy { background: var(--accent-color); color: black; }

  .share-btn:hover {
    transform: translateY(-2px);
    opacity: 0.9;
  }

  .share-url {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin: 10px 0;
    background: var(--bg-color);
    color: var(--text-color);
  }

  /* Indicador de usuários online */
  .usuarios-online {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--card-bg);
    padding: 10px 15px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    z-index: 20;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .usuarios-online .contador {
    background: #27ae60;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
  }

  /* Responsividade */
  @media (max-width: 768px) {
    .aviso {
      font-size: 14px;
      padding: 8px 16px;
    }
    
    .info {
      font-size: 12px;
      min-width: 150px;
      padding: 10px 15px;
    }
    
    .menu {
      min-width: 90px;
      font-size: 10px;
      padding: 4px 6px;
    }
    
    .conteudo {
      font-size: 9px;
    }
    
    .sol {
      width: 70px;
      height: 70px;
      top: 20px;
      right: 20px;
    }
    
    .lua {
      width: 60px;
      height: 60px;
      top: 30px;
      left: 30px;
    }
    
    .controls {
      bottom: 15px;
      left: 15px;
    }
    
    .btn {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .bolinhas-container {
      top: 70px;
      left: 15px;
      gap: 10px;
      padding: 8px;
    }
    
    .bolinha {
      width: 40px;
      height: 40px;
      font-size: 16px;
    }
    
    .bolinha-info {
      min-width: 70px;
      max-width: 120px;
      padding: 4px 6px;
    }
    
    .horario-input, .nome-input {
      font-size: 10px;
    }
    
    .bolinha-wrapper .delete-btn {
      width: 18px;
      height: 18px;
      font-size: 12px;
      top: -6px;
      right: -6px;
    }

    .share-buttons {
      flex-direction: column;
    }

    .share-btn {
      min-width: 100%;
    }

    .usuarios-online {
      bottom: 15px;
      right: 15px;
      font-size: 11px;
    }
  }

  @media (max-width: 480px) {
    .menu {
      min-width: 80px;
      font-size: 9px;
      padding: 3px 5px;
    }
    
    .conteudo {
      font-size: 8px;
    }
    
    .aviso {
      font-size: 12px;
      padding: 6px 12px;
    }
    
    .controls {
      bottom: 10px;
      left: 10px;
    }
    
    .btn {
      width: 35px;
      height: 35px;
      font-size: 12px;
    }
    
    .bolinhas-container {
      top: 60px;
      left: 10px;
      gap: 8px;
      padding: 6px;
    }
    
    .bolinha {
      width: 35px;
      height: 35px;
      font-size: 14px;
    }
    
    .bolinha-info {
      min-width: 60px;
      max-width: 100px;
      padding: 3px 5px;
    }
    
    .horario-input, .nome-input {
      font-size: 9px;
    }
    
    .bolinha-wrapper .delete-btn {
      width: 16px;
      height: 16px;
      font-size: 10px;
      top: -5px;
      right: -5px;
    }
  }
</style>
</head>
<body>

<div class="aviso" role="alert" aria-live="polite">
  🟡 <b>TEMPO REAL ATIVO</b> | Movimentos sincronizados entre todos os usuários | Online: <span id="contadorUsuarios">1</span> 🟡
</div>

<div class="info" aria-live="polite">
  Data: <span id="data">00/00/00</span><br>
  Hora: <span id="hora">00:00</span><br>
  Temperatura: <span id="temperatura">--°C</span><br>
  Condição: <span id="condicao">--</span>
</div>

<div class="status-conexao connecting" id="statusConexao">
  <div class="ponto-status"></div>
  <span>Conectando...</span>
</div>

<div class="usuarios-online">
  👥 Online: <span class="contador" id="contadorOnline">1</span>
</div>

<div class="mapa-container">
  <!-- IMAGEM ATUALIZADA COM O MAPA DE PALOTINA -->
  <img src="https://i.imgur.com/mwZz8bw.jpeg" 
       alt="Mapa de Palotina" 
       class="mapa-img"
       onerror="this.src='https://i.imgur.com/mwZz8bw.jpeg'">

  <!-- CICLO DIA/NOITE -->
  <div class="ciclo-dia-noite" id="cicloDiaNoite"></div>
  
  <!-- ESTRELAS -->
  <div class="estrelas" id="estrelas"></div>
  
  <!-- LUA - AGORA DEVE APARECER CORRETAMENTE -->
  <div class="lua" id="lua"></div>

  <!-- Efeito de escurecimento para clima -->
  <div class="escurecer-tela" id="escurecerTela"></div>

  <!-- Efeito de gotas na tela -->
  <div class="gotas-tela" id="gotasTela"></div>

  <!-- Menus posicionados sobre o mapa -->
  <button class="menu" id="saoCamilo" aria-expanded="false">
    São Camilo
    <div class="conteudo" role="region">
      <p>Ida: 20 min</p>
      <p>Volta: 20 min</p>
      <p>Tempo médio partindo da QI: 20 min</p>
    </div>
  </button>

  <button class="menu" id="palmital" aria-expanded="false">
    Palmital
    <div class="conteudo" role="region">
      <p>Ida: 20 min</p>
      <p>Volta: 20 min</p>
      <p>Tempo médio partindo da QI: 20 min</p>
    </div>
  </button>

  <button class="menu" id="boaVista" aria-expanded="false">
    Boa Vista
    <div class="conteudo" role="region">
      <p>Ida: 15 min</p>
      <p>Volta: 15 min</p>
      <p>Tempo médio partindo da QI: 15 min</p>
    </div>
  </button>

  <button class="menu" id="altoSantaFe" aria-expanded="false">
    Alto Santa Fé
    <div class="conteudo" role="region">
      <p>Ida: 20 min</p>
      <p>Volta: 20 min</p>
      <p>Tempo médio partindo da QI: 20 min</p>
    </div>
  </button>

  <button class="menu" id="maripa" aria-expanded="false">
    Maripá
    <div class="conteudo" role="region">
      <p>Ida: 25 min</p>
      <p>Volta: 25 min</p>
      <p>Tempo médio partindo da QI: 25 min</p>
    </div>
  </button>

  <button class="menu" id="cincoMil" aria-expanded="false">
    Cinco Mil
    <div class="conteudo" role="region">
      <p>Ida: 25 min</p>
      <p>Volta: 25 min</p>
      <p>Tempo médio partindo da QI: 25 min</p>
    </div>
  </button>

  <button class="menu" id="vilaNice" aria-expanded="false">
    Vila Nice
    <div class="conteudo" role="region">
      <p>Ida: 25 min</p>
      <p>Volta: 25 min</p>
      <p>Tempo médio partindo da QI: 25 min</p>
    </div>
  </button>

  <button class="menu" id="vilaSantoAntonio" aria-expanded="false">
    Vila Santo Antônio
    <div class="conteudo" role="region">
      <p>Ida: 15 min</p>
      <p>Volta: 15 min</p>
      <p>Tempo médio partindo da QI: 15 min</p>
    </div>
  </button>

  <button class="menu" id="vilaLaSalle" aria-expanded="false">
    Vila La Salle
    <div class="conteudo" role="region">
      <p>Ida: 18 min</p>
      <p>Volta: 18 min</p>
      <p>Tempo médio partindo da QI: 18 min</p>
    </div>
  </button>

  <button class="menu" id="vilaFloresta" aria-expanded="false">
    Vila Floresta
    <div class="conteudo" role="region">
      <p>Ida: 30 min</p>
      <p>Volta: 30 min</p>
      <p>Tempo médio partindo da QI: 30 min</p>
    </div>
  </button>

  <button class="menu" id="esquinaProgresso" aria-expanded="false">
    Esquina Progresso
    <div class="conteudo" role="region">
      <p>Ida: 10 min</p>
      <p>Volta: 10 min</p>
      <p>Tempo médio partindo da QI: 10 min</p>
    </div>
  </button>

  <button class="menu" id="linhaPecuaria" aria-expanded="false">
    Linha Pecuária
    <div class="conteudo" role="region">
      <p>Ida: 15 min</p>
      <p>Volta: 15 min</p>
      <p>Tempo médio partindo da QI: 15 min</p>
    </div>
  </button>

  <button class="menu" id="linhaSaoCarlos" aria-expanded="false">
    Linha São Carlos
    <div class="conteudo" role="region">
      <p>Ida: 25 min</p>
      <p>Volta: 25 min</p>
      <p>Tempo médio partindo da QI: 25 min</p>
    </div>
  </button>

  <!-- Animações climáticas -->
  <div class="chuva" id="chuva" aria-hidden="true"></div>
  <div class="nuvens" id="nuvens" aria-hidden="true"></div>
  <div class="sol" id="sol" aria-hidden="true"></div>
  <div class="neve" id="neve" aria-hidden="true"></div>
  <div class="tempestade" id="tempestade" aria-hidden="true"></div>
</div>

<!-- CONTAINER PARA AS BOLINHAS A, E, W - UMA EMBAIXO DA OUTRA -->
<div class="bolinhas-container" id="bolinhasContainer">
  <!-- Bolinhas originais -->
  <div class="bolinha bolinha-original verde" id="bolinhaA" data-cor="verde">
    <span class="bolinha-texto">A</span>
    <input type="text" class="bolinha-input" maxlength="1" value="A">
  </div>
  <div class="bolinha bolinha-original azul" id="bolinhaE" data-cor="azul">
    <span class="bolinha-texto">E</span>
    <input type="text" class="bolinha-input" maxlength="1" value="E">
  </div>
  <div class="bolinha bolinha-original vermelha" id="bolinhaW" data-cor="vermelha">
    <span class="bolinha-texto">W</span>
    <input type="text" class="bolinha-input" maxlength="1" value="W">
  </div>
</div>

<div class="controls">
  <button class="btn" id="darkMode" aria-label="Alternar modo escuro">🌙</button>
  <button class="btn" id="refresh" aria-label="Atualizar dados climáticos">↻</button>
  <button class="btn" id="salvarPosicoes" aria-label="Salvar posições dos menus" title="Salvar posições">💾</button>
  <button class="btn" id="resetPosicoes" aria-label="Resetar posições dos menus" title="Resetar posições">🔄</button>
  <button class="btn" id="shareBtn" aria-label="Compartilhar mapa" title="Compartilhar">📤</button>
</div>

<!-- Modal de compartilhamento -->
<div class="modal" id="shareModal">
  <div class="modal-content">
    <h3>📤 Compartilhar Mapa</h3>
    <p>Compartilhe este mapa interativo com outras pessoas:</p>
    
    <input type="text" class="share-url" id="shareUrl" readonly value="Carregando...">
    
    <div class="share-buttons">
      <button class="share-btn whatsapp" onclick="shareWhatsApp()">📱 WhatsApp</button>
      <button class="share-btn email" onclick="shareEmail()">📧 Email</button>
      <button class="share-btn link" onclick="shareLink()">🔗 Copiar Link</button>
      <button class="share-btn copy" onclick="copyLink()">📋 Copiar</button>
    </div>
    
    <button class="btn" onclick="closeShareModal()" style="width: 100%; margin-top: 10px;">Fechar</button>
  </div>
</div>

<script>
// ========== CONFIGURAÇÃO DE VERSÃO E WEBSOCKET ==========
const VERSAO = '4.0.0-railway-prod';
const MAX_USUARIOS = 15;

// ⚠️⚠️⚠️ ATUALIZE ESTA URL APÓS O DEPLOY NO RAILWAY ⚠️⚠️⚠️
const WS_SERVER = 'wss://seu-projeto.up.railway.app';

// Sistema de WebSocket para tempo real
class WebSocketSystem {
  constructor() {
    this.socket = null;
    this.conectado = false;
    this.tentativas = 0;
    this.maxTentativas = 10;
    this.userId = this.gerarUserId();
    this.reconnectDelay = 1000;
    this.init();
  }

  gerarUserId() {
    return 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
  }

  init() {
    this.conectar();
    
    // Tentar reconectar periodicamente
    setInterval(() => {
      if (!this.conectado && this.tentativas < this.maxTentativas) {
        console.log('🔄 Tentando reconectar...');
        this.conectar();
      }
    }, 10000); // Tentar a cada 10 segundos
  }

  conectar() {
    try {
      if (this.socket) {
        this.socket.close();
      }
      
      console.log(`🔗 Conectando ao servidor: ${WS_SERVER}`);
      this.socket = new WebSocket(WS_SERVER);
      this.tentativas++;
      this.atualizarStatus('connecting');
      
      this.socket.onopen = () => {
        console.log('✅ Conectado ao servidor WebSocket Railway');
        this.conectado = true;
        this.tentativas = 0;
        this.reconnectDelay = 1000;
        this.atualizarStatus('online');
        
        // Enviar mensagem de entrada
        this.enviar({
          tipo: 'entrada',
          userId: this.userId,
          versao: VERSAO,
          timestamp: new Date().toISOString()
        });
      };

      this.socket.onmessage = (event) => {
        try {
          const mensagem = JSON.parse(event.data);
          this.processarMensagem(mensagem);
        } catch (e) {
          console.warn('⚠️ Mensagem não-JSON recebida:', event.data);
        }
      };

      this.socket.onclose = (event) => {
        console.log(`🔌 Conexão fechada: ${event.code} - ${event.reason}`);
        this.conectado = false;
        this.atualizarStatus('offline');
        
        // Reconexão exponencial
        if (this.tentativas < this.maxTentativas) {
          setTimeout(() => {
            this.reconnectDelay = Math.min(this.reconnectDelay * 1.5, 30000);
            this.conectar();
          }, this.reconnectDelay);
        }
      };

      this.socket.onerror = (error) => {
        console.error('❌ Erro WebSocket:', error);
        this.conectado = false;
        this.atualizarStatus('offline');
      };

    } catch (error) {
      console.error('❌ Erro ao conectar:', error);
      this.conectado = false;
      this.atualizarStatus('offline');
    }
  }

  atualizarStatus(status) {
    const elemento = document.getElementById('statusConexao');
    elemento.className = `status-conexao ${status}`;
    
    switch(status) {
      case 'online':
        elemento.innerHTML = '<div class="ponto-status"></div><span>Conectado</span>';
        break;
      case 'offline':
        elemento.innerHTML = '<div class="ponto-status"></div><span>Offline</span>';
        break;
      case 'connecting':
        elemento.innerHTML = '<div class="ponto-status"></div><span>Conectando...</span>';
        break;
    }
  }

  enviar(mensagem) {
    if (this.conectado && this.socket && this.socket.readyState === WebSocket.OPEN) {
      try {
        mensagem.userId = this.userId;
        mensagem.timestamp = new Date().toISOString();
        this.socket.send(JSON.stringify(mensagem));
        return true;
      } catch (error) {
        console.error('❌ Erro ao enviar mensagem:', error);
        return false;
      }
    } else {
      console.warn('⚠️ WebSocket não conectado. Mensagem não enviada:', mensagem.tipo);
      return false;
    }
  }

  processarMensagem(mensagem) {
    // Ignorar próprias mensagens (por userId)
    if (mensagem.userId === this.userId) return;

    console.log(`📨 Mensagem recebida [${mensagem.tipo}] de ${mensagem.userId}`);
    
    switch(mensagem.tipo) {
      case 'movimento_menu':
        this.atualizarMenu(mensagem.menuId, mensagem.posicao);
        break;
      case 'nova_bolinha':
        this.adicionarBolinhaRemota(mensagem.bolinha);
        break;
      case 'movimento_bolinha':
        this.moverBolinhaRemota(mensagem.bolinhaId, mensagem.posicao);
        break;
      case 'excluir_bolinha':
        this.excluirBolinhaRemota(mensagem.bolinhaId);
        break;
      case 'usuarios_online':
        this.atualizarContadorUsuarios(mensagem.contador);
        break;
      case 'conexao_estabelecida':
        console.log('✅ Conexão estabelecida com servidor');
        break;
      case 'health_check':
        // Manter conexão ativa
        break;
      case 'servidor_desligando':
        console.log('⚠️ Servidor será reiniciado em breve');
        this.mostrarNotificacao('Servidor será reiniciado em breve');
        break;
    }
  }

  atualizarMenu(menuId, posicao) {
    const menu = document.getElementById(menuId);
    if (menu) {
      // Animação suave para movimentos remotos
      menu.style.transition = 'all 0.3s ease';
      menu.style.left = posicao.left + 'px';
      menu.style.top = posicao.top + 'px';
      
      setTimeout(() => {
        menu.style.transition = '';
      }, 300);
    }
  }

  adicionarBolinhaRemota(bolinhaData) {
    if (!document.getElementById(bolinhaData.id)) {
      bolinhasSystem.createBolinhaFromData(bolinhaData);
    }
  }

  moverBolinhaRemota(bolinhaId, posicao) {
    const bolinha = document.getElementById(bolinhaId);
    if (bolinha) {
      bolinha.style.transition = 'all 0.3s ease';
      bolinha.style.left = posicao.left + 'px';
      bolinha.style.top = posicao.top + 'px';
      
      setTimeout(() => {
        bolinha.style.transition = '';
      }, 300);
    }
  }

  excluirBolinhaRemota(bolinhaId) {
    const bolinha = document.getElementById(bolinhaId);
    if (bolinha) {
      bolinha.remove();
      bolinhasSystem.saveBolinhas();
    }
  }

  atualizarContadorUsuarios(contador) {
    document.getElementById('contadorUsuarios').textContent = contador;
    document.getElementById('contadorOnline').textContent = contador;
  }

  mostrarNotificacao(mensagem) {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #f39c12;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      z-index: 1000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    notification.textContent = `⚠️ ${mensagem}`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 5000);
  }
}

// ========== SISTEMA DE BOLINHAS ATUALIZADO ==========
class BolinhasSystem {
  constructor() {
    this.dragging = false;
    this.currentBolinhaWrapper = null;
    this.cloneBolinhaWrapper = null;
    this.startX = 0;
    this.startY = 0;
    this.startLeft = 0;
    this.startTop = 0;
    this.bolinhasContainer = document.getElementById('bolinhasContainer');
    
    this.init();
  }

  init() {
    const bolinhasOriginais = document.querySelectorAll('.bolinha-original');
    bolinhasOriginais.forEach(bolinha => {
      this.addBolinhaEventListeners(bolinha);
    });

    document.addEventListener('mousemove', this.drag.bind(this));
    document.addEventListener('mouseup', this.stopDrag.bind(this));
    document.addEventListener('touchmove', this.dragTouch.bind(this), { passive: false });
    document.addEventListener('touchend', this.stopDrag.bind(this));
    
    this.loadBolinhas();
  }

  addBolinhaEventListeners(bolinha) {
    if (bolinha.classList.contains('bolinha-original')) {
      bolinha.addEventListener('mousedown', this.startDragOriginal.bind(this));
      bolinha.addEventListener('touchstart', this.startDragOriginalTouch.bind(this), { passive: false });
    }
    
    bolinha.addEventListener('dblclick', this.editBolinha.bind(this));
  }

  addDeleteButton(bolinhaWrapper) {
    if (!bolinhaWrapper.querySelector('.delete-btn')) {
      const deleteBtn = document.createElement('div');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '×';
      
      deleteBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.deleteBolinha(bolinhaWrapper);
      });
      
      bolinhaWrapper.appendChild(deleteBtn);
    }
  }

  startDragOriginal(e) {
    e.preventDefault();
    e.stopPropagation();
    
    this.dragging = true;
    const bolinha = e.currentTarget;
    
    this.startX = e.clientX;
    this.startY = e.clientY;
    
    const rect = bolinha.getBoundingClientRect();
    this.startLeft = rect.left;
    this.startTop = rect.top;
    
    bolinha.classList.add('arrastando');
    this.createClone(bolinha);
  }

  startDragOriginalTouch(e) {
    e.preventDefault();
    e.stopPropagation();
    
    if (e.touches.length !== 1) return;
    
    this.dragging = true;
    const bolinha = e.currentTarget;
    
    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    
    const rect = bolinha.getBoundingClientRect();
    this.startLeft = rect.left;
    this.startTop = rect.top;
    
    bolinha.classList.add('arrastando');
    this.createClone(bolinha);
  }

  startDragCopy(e) {
    if (e.target.classList.contains('delete-btn') || 
        e.target.classList.contains('bolinha-input') ||
        e.target.classList.contains('horario-input') ||
        e.target.classList.contains('nome-input')) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    this.dragging = true;
    this.currentBolinhaWrapper = e.currentTarget.closest('.bolinha-wrapper');
    
    this.startX = e.clientX;
    this.startY = e.clientY;
    
    const style = window.getComputedStyle(this.currentBolinhaWrapper);
    this.startLeft = parseFloat(style.left);
    this.startTop = parseFloat(style.top);
    
    this.currentBolinhaWrapper.classList.add('arrastando');
    this.currentBolinhaWrapper.style.zIndex = '100';
    
    const deleteBtn = this.currentBolinhaWrapper.querySelector('.delete-btn');
    if (deleteBtn) {
      deleteBtn.style.opacity = '0';
    }
  }

  startDragCopyTouch(e) {
    if (e.target.classList.contains('delete-btn') || 
        e.target.classList.contains('bolinha-input') ||
        e.target.classList.contains('horario-input') ||
        e.target.classList.contains('nome-input')) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    if (e.touches.length !== 1) return;
    
    this.dragging = true;
    this.currentBolinhaWrapper = e.currentTarget.closest('.bolinha-wrapper');
    
    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    
    const style = window.getComputedStyle(this.currentBolinhaWrapper);
    this.startLeft = parseFloat(style.left);
    this.startTop = parseFloat(style.top);
    
    this.currentBolinhaWrapper.classList.add('arrastando');
    this.currentBolinhaWrapper.style.zIndex = '100';
    
    const deleteBtn = this.currentBolinhaWrapper.querySelector('.delete-btn');
    if (deleteBtn) {
      deleteBtn.style.opacity = '0';
    }
  }

  createClone(originalBolinha) {
    // Criar wrapper para a bolinha e informações
    this.cloneBolinhaWrapper = document.createElement('div');
    this.cloneBolinhaWrapper.className = 'bolinha-wrapper livre';
    this.cloneBolinhaWrapper.style.position = 'fixed';
    this.cloneBolinhaWrapper.style.left = this.startLeft + 'px';
    this.cloneBolinhaWrapper.style.top = this.startTop + 'px';
    this.cloneBolinhaWrapper.style.zIndex = '100';
    this.cloneBolinhaWrapper.id = 'bolinha_' + Date.now();
    
    // Clonar a bolinha
    const bolinhaClone = originalBolinha.cloneNode(true);
    bolinhaClone.classList.remove('bolinha-original');
    bolinhaClone.classList.add('livre');
    
    // Criar container de informações
    const infoContainer = document.createElement('div');
    infoContainer.className = 'bolinha-info';
    
    // Campo de horário
    const horarioInput = document.createElement('input');
    horarioInput.type = 'text';
    horarioInput.className = 'horario-input';
    horarioInput.placeholder = 'HH:MM';
    horarioInput.maxLength = 5;
    
    // Campo de nome (textarea para ajuste automático)
    const nomeInput = document.createElement('textarea');
    nomeInput.className = 'nome-input';
    nomeInput.placeholder = 'Nome';
    nomeInput.rows = 1;
    
    // Configurar auto-ajuste do textarea
    nomeInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    infoContainer.appendChild(horarioInput);
    infoContainer.appendChild(nomeInput);
    
    // Adicionar elementos ao wrapper
    this.cloneBolinhaWrapper.appendChild(bolinhaClone);
    this.cloneBolinhaWrapper.appendChild(infoContainer);
    
    // Adicionar eventos
    this.addBolinhaWrapperEventListeners(this.cloneBolinhaWrapper);
    document.body.appendChild(this.cloneBolinhaWrapper);
    
    // Focar no campo de horário
    setTimeout(() => {
      horarioInput.focus();
    }, 100);
  }

  addBolinhaWrapperEventListeners(bolinhaWrapper) {
    bolinhaWrapper.addEventListener('mousedown', this.startDragCopy.bind(this));
    bolinhaWrapper.addEventListener('touchstart', this.startDragCopyTouch.bind(this), { passive: false });
    this.addDeleteButton(bolinhaWrapper);
    
    // Adicionar eventos para os campos de input
    const horarioInput = bolinhaWrapper.querySelector('.horario-input');
    const nomeInput = bolinhaWrapper.querySelector('.nome-input');
    
    horarioInput.addEventListener('input', () => this.saveBolinhas());
    nomeInput.addEventListener('input', () => this.saveBolinhas());
    
    // Formatar horário automaticamente
    horarioInput.addEventListener('input', function(e) {
      let value = this.value.replace(/\D/g, '');
      if (value.length >= 3) {
        value = value.substring(0, 2) + ':' + value.substring(2, 4);
      }
      this.value = value;
    });
  }

  drag(e) {
    if (!this.dragging) return;
    
    e.preventDefault();
    
    const deltaX = e.clientX - this.startX;
    const deltaY = e.clientY - this.startY;
    
    if (this.cloneBolinhaWrapper) {
      this.cloneBolinhaWrapper.style.left = (this.startLeft + deltaX) + 'px';
      this.cloneBolinhaWrapper.style.top = (this.startTop + deltaY) + 'px';
    } else if (this.currentBolinhaWrapper) {
      this.currentBolinhaWrapper.style.left = (this.startLeft + deltaX) + 'px';
      this.currentBolinhaWrapper.style.top = (this.startTop + deltaY) + 'px';
      
      // Enviar movimento em tempo real
      if (webSocketSystem.conectado) {
        webSocketSystem.enviar({
          tipo: 'movimento_bolinha',
          bolinhaId: this.currentBolinhaWrapper.id,
          posicao: {
            left: parseFloat(this.currentBolinhaWrapper.style.left),
            top: parseFloat(this.currentBolinhaWrapper.style.top)
          }
        });
      }
    }
  }

  dragTouch(e) {
    if (!this.dragging || !this.currentBolinhaWrapper || e.touches.length !== 1) return;
    
    e.preventDefault();
    
    const deltaX = e.touches[0].clientX - this.startX;
    const deltaY = e.touches[0].clientY - this.startY;
    
    if (this.cloneBolinhaWrapper) {
      this.cloneBolinhaWrapper.style.left = (this.startLeft + deltaX) + 'px';
      this.cloneBolinhaWrapper.style.top = (this.startTop + deltaY) + 'px';
    } else if (this.currentBolinhaWrapper) {
      this.currentBolinhaWrapper.style.left = (this.startLeft + deltaX) + 'px';
      this.currentBolinhaWrapper.style.top = (this.startTop + deltaY) + 'px';
      
      if (webSocketSystem.conectado) {
        webSocketSystem.enviar({
          tipo: 'movimento_bolinha',
          bolinhaId: this.currentBolinhaWrapper.id,
          posicao: {
            left: parseFloat(this.currentBolinhaWrapper.style.left),
            top: parseFloat(this.currentBolinhaWrapper.style.top)
          }
        });
      }
    }
  }

  stopDrag() {
    if (!this.dragging) return;
    
    this.dragging = false;
    
    if (this.currentBolinhaWrapper) {
      this.currentBolinhaWrapper.classList.remove('arrastando');
      this.currentBolinhaWrapper.style.zIndex = '21';
    }
    
    if (this.cloneBolinhaWrapper) {
      this.cloneBolinhaWrapper.style.zIndex = '21';
      
      // Enviar nova bolinha para outros usuários
      if (webSocketSystem.conectado) {
        const bolinhaData = this.getBolinhaData(this.cloneBolinhaWrapper);
        webSocketSystem.enviar({
          tipo: 'nova_bolinha',
          bolinha: bolinhaData
        });
      }
      
      this.saveBolinhas();
      this.cloneBolinhaWrapper = null;
    }
    
    this.saveBolinhas();
    this.currentBolinhaWrapper = null;
  }

  deleteBolinha(bolinhaWrapper) {
    if (bolinhaWrapper && bolinhaWrapper.classList.contains('livre')) {
      // Enviar exclusão para outros usuários
      if (webSocketSystem.conectado) {
        webSocketSystem.enviar({
          tipo: 'excluir_bolinha',
          bolinhaId: bolinhaWrapper.id
        });
      }
      
      bolinhaWrapper.remove();
      this.saveBolinhas();
    }
  }

  editBolinha(e) {
    if (e.target.classList.contains('delete-btn')) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const bolinha = e.currentTarget;
    const texto = bolinha.querySelector('.bolinha-texto');
    const input = bolinha.querySelector('.bolinha-input');
    
    bolinha.classList.add('editando');
    input.focus();
    input.select();
    
    const saveEdit = () => {
      const novoValor = input.value.trim().toUpperCase();
      if (novoValor) {
        texto.textContent = novoValor;
        input.value = novoValor;
        this.saveBolinhas();
      }
      bolinha.classList.remove('editando');
      input.removeEventListener('blur', saveEdit);
    };
    
    input.addEventListener('blur', saveEdit);
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        input.blur();
      }
    });
  }

  getBolinhaData(bolinhaWrapper) {
    const bolinha = bolinhaWrapper.querySelector('.bolinha');
    const horarioInput = bolinhaWrapper.querySelector('.horario-input');
    const nomeInput = bolinhaWrapper.querySelector('.nome-input');
    
    return {
      id: bolinhaWrapper.id,
      texto: bolinha.querySelector('.bolinha-texto').textContent,
      cor: bolinha.dataset.cor,
      left: parseFloat(bolinhaWrapper.style.left),
      top: parseFloat(bolinhaWrapper.style.top),
      horario: horarioInput.value,
      nome: nomeInput.value
    };
  }

  saveBolinhas() {
    const bolinhasWrappers = document.querySelectorAll('.bolinha-wrapper.livre');
    const bolinhasData = [];
    
    bolinhasWrappers.forEach(wrapper => {
      bolinhasData.push(this.getBolinhaData(wrapper));
    });
    
    localStorage.setItem('mapa-palotina-bolinhas', JSON.stringify(bolinhasData));
  }

  loadBolinhas() {
    const saved = localStorage.getItem('mapa-palotina-bolinhas');
    if (saved) {
      try {
        const bolinhasData = JSON.parse(saved);
        bolinhasData.forEach(bolinhaData => {
          this.createBolinhaFromData(bolinhaData);
        });
      } catch (e) {
        console.error('Erro ao carregar bolinhas:', e);
      }
    }
  }

  createBolinhaFromData(bolinhaData) {
    const original = document.querySelector(`.bolinha-original[data-cor="${bolinhaData.cor}"]`);
    if (!original) return;
    
    // Criar wrapper
    const bolinhaWrapper = document.createElement('div');
    bolinhaWrapper.className = 'bolinha-wrapper livre';
    bolinhaWrapper.id = bolinhaData.id;
    bolinhaWrapper.style.position = 'fixed';
    bolinhaWrapper.style.left = bolinhaData.left + 'px';
    bolinhaWrapper.style.top = bolinhaData.top + 'px';
    bolinhaWrapper.style.zIndex = '21';
    
    // Clonar bolinha
    const bolinha = original.cloneNode(true);
    bolinha.classList.remove('bolinha-original');
    bolinha.classList.add('livre');
    
    const textoElement = bolinha.querySelector('.bolinha-texto');
    const inputElement = bolinha.querySelector('.bolinha-input');
    if (textoElement.textContent !== bolinhaData.texto) {
      textoElement.textContent = bolinhaData.texto;
      inputElement.value = bolinhaData.texto;
    }
    
    // Criar container de informações
    const infoContainer = document.createElement('div');
    infoContainer.className = 'bolinha-info';
    
    // Campo de horário
    const horarioInput = document.createElement('input');
    horarioInput.type = 'text';
    horarioInput.className = 'horario-input';
    horarioInput.placeholder = 'HH:MM';
    horarioInput.maxLength = 5;
    horarioInput.value = bolinhaData.horario || '';
    
    // Campo de nome
    const nomeInput = document.createElement('textarea');
    nomeInput.className = 'nome-input';
    nomeInput.placeholder = 'Nome';
    nomeInput.rows = 1;
    nomeInput.value = bolinhaData.nome || '';
    
    // Configurar auto-ajuste do textarea
    nomeInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (nomeInput.scrollHeight) + 'px';
    });
    
    // Ajustar altura inicial
    setTimeout(() => {
      nomeInput.style.height = 'auto';
      nomeInput.style.height = (nomeInput.scrollHeight) + 'px';
    }, 10);
    
    infoContainer.appendChild(horarioInput);
    infoContainer.appendChild(nomeInput);
    
    // Adicionar elementos ao wrapper
    bolinhaWrapper.appendChild(bolinha);
    bolinhaWrapper.appendChild(infoContainer);
    
    // Adicionar eventos
    this.addBolinhaWrapperEventListeners(bolinhaWrapper);
    document.body.appendChild(bolinhaWrapper);
  }
}

// ========== SISTEMA DE ARRASTAR MENUS ATUALIZADO ==========
class DragSystem {
  constructor() {
    this.dragging = false;
    this.currentMenu = null;
    this.startX = 0;
    this.startY = 0;
    this.startLeft = 0;
    this.startTop = 0;
    
    this.init();
  }

  init() {
    const menus = document.querySelectorAll('.menu');
    
    menus.forEach(menu => {
      menu.addEventListener('mousedown', this.startDrag.bind(this));
      menu.addEventListener('touchstart', this.startDragTouch.bind(this), { passive: false });
      menu.addEventListener('click', this.handleClick.bind(this));
    });

    document.addEventListener('mousemove', this.drag.bind(this));
    document.addEventListener('mouseup', this.stopDrag.bind(this));
    document.addEventListener('touchmove', this.dragTouch.bind(this), { passive: false });
    document.addEventListener('touchend', this.stopDrag.bind(this));
  }

  startDrag(e) {
    e.preventDefault();
    this.dragging = true;
    this.currentMenu = e.target;
    
    this.startX = e.clientX;
    this.startY = e.clientY;
    
    const style = window.getComputedStyle(this.currentMenu);
    this.startLeft = parseFloat(style.left);
    this.startTop = parseFloat(style.top);
    
    this.currentMenu.classList.add('arrastando');
    this.currentMenu.style.cursor = 'grabbing';
  }

  startDragTouch(e) {
    e.preventDefault();
    if (e.touches.length !== 1) return;
    
    this.dragging = true;
    this.currentMenu = e.target;
    
    this.startX = e.touches[0].clientX;
    this.startY = e.touches[0].clientY;
    
    const style = window.getComputedStyle(this.currentMenu);
    this.startLeft = parseFloat(style.left);
    this.startTop = parseFloat(style.top);
    
    this.currentMenu.classList.add('arrastando');
  }

  drag(e) {
    if (!this.dragging || !this.currentMenu) return;
    
    e.preventDefault();
    
    const deltaX = e.clientX - this.startX;
    const deltaY = e.clientY - this.startY;
    
    this.currentMenu.style.left = (this.startLeft + deltaX) + 'px';
    this.currentMenu.style.top = (this.startTop + deltaY) + 'px';
    
    // Enviar movimento em tempo real
    if (webSocketSystem.conectado) {
      webSocketSystem.enviar({
        tipo: 'movimento_menu',
        menuId: this.currentMenu.id,
        posicao: {
          left: parseFloat(this.currentMenu.style.left),
          top: parseFloat(this.currentMenu.style.top)
        }
      });
    }
  }

  dragTouch(e) {
    if (!this.dragging || !this.currentMenu || e.touches.length !== 1) return;
    
    e.preventDefault();
    
    const deltaX = e.touches[0].clientX - this.startX;
    const deltaY = e.touches[0].clientY - this.startY;
    
    this.currentMenu.style.left = (this.startLeft + deltaX) + 'px';
    this.currentMenu.style.top = (this.startTop + deltaY) + 'px';
    
    if (webSocketSystem.conectado) {
      webSocketSystem.enviar({
        tipo: 'movimento_menu',
        menuId: this.currentMenu.id,
        posicao: {
          left: parseFloat(this.currentMenu.style.left),
          top: parseFloat(this.currentMenu.style.top)
        }
      });
    }
  }

  stopDrag() {
    if (!this.dragging) return;
    
    this.dragging = false;
    
    if (this.currentMenu) {
      this.currentMenu.classList.remove('arrastando');
      this.currentMenu.style.cursor = 'grab';
      this.currentMenu = null;
    }
  }

  handleClick(e) {
    if (this.dragging) {
      e.preventDefault();
      e.stopPropagation();
      this.dragging = false;
      return false;
    }
    return true;
  }
}

// ========== SISTEMAS EXISTENTES ==========
class CicloDiaNoite {
  constructor() {
    this.cicloElement = document.getElementById('cicloDiaNoite');
    this.estrelasElement = document.getElementById('estrelas');
    this.luaElement = document.getElementById('lua');
    this.solElement = document.getElementById('sol');
    
    this.criarEstrelasRealistas();
    this.atualizarCiclo();
    setInterval(() => this.atualizarCiclo(), 60000);
  }

  criarEstrelasRealistas() {
    // Criar estrelas com cores e tamanhos variados
    const tiposEstrela = ['azulada', 'amarelada', 'alaranjada'];
    
    for (let i = 0; i < 200; i++) {
      const estrela = document.createElement('div');
      const tipo = tiposEstrela[Math.floor(Math.random() * tiposEstrela.length)];
      const tamanho = Math.random() * 3 + 1;
      
      estrela.className = `estrela ${tipo}`;
      estrela.style.width = tamanho + 'px';
      estrela.style.height = tamanho + 'px';
      estrela.style.left = Math.random() * 100 + 'vw';
      estrela.style.top = Math.random() * 100 + 'vh';
      estrela.style.animationDelay = (Math.random() * 6) + 's';
      estrela.style.animationDuration = (3 + Math.random() * 4) + 's';
      
      this.estrelasElement.appendChild(estrela);
    }
  }

  atualizarCiclo() {
    const agora = new Date();
    const hora = agora.getHours();
    const minuto = agora.getMinutes();
    const horaDecimal = hora + minuto / 60;

    this.cicloElement.className = 'ciclo-dia-noite';
    this.estrelasElement.classList.remove('visivel');
    this.luaElement.classList.remove('visivel');
    this.solElement.classList.remove('visivel');

    if (horaDecimal >= 0 && horaDecimal < 5) {
      this.cicloElement.classList.add('madrugada');
      this.estrelasElement.classList.add('visivel');
      this.luaElement.classList.add('visivel'); // CORRIGIDO: Lua visível na madrugada
    } else if (horaDecimal >= 5 && horaDecimal < 7) {
      this.cicloElement.classList.add('amanhecer');
      this.solElement.classList.add('visivel');
    } else if (horaDecimal >= 7 && horaDecimal < 12) {
      this.cicloElement.classList.add('manha');
      this.solElement.classList.add('visivel');
    } else if (horaDecimal >= 12 && horaDecimal < 17) {
      this.cicloElement.classList.add('tarde');
      this.solElement.classList.add('visivel');
    } else if (horaDecimal >= 17 && horaDecimal < 19) {
      this.cicloElement.classList.add('entardecer');
      this.solElement.classList.add('visivel');
    } else {
      this.cicloElement.classList.add('noite');
      this.estrelasElement.classList.add('visivel');
      this.luaElement.classList.add('visivel'); // CORRIGIDO: Lua visível na noite
    }
  }
}

class WeatherEffects {
  constructor() {
    this.escurecerTela = document.getElementById('escurecerTela');
    this.gotasTela = document.getElementById('gotasTela');
    this.mapaImg = document.querySelector('.mapa-img');
  }

  clearEffects() {
    this.escurecerTela.className = 'escurecer-tela';
    this.gotasTela.classList.remove('visivel');
    this.gotasTela.innerHTML = '';
    this.mapaImg.className = 'mapa-img';
    
    const elements = ['chuva', 'nuvens', 'sol', 'neve', 'tempestade'];
    elements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.innerHTML = '';
        element.style.display = 'none';
      }
    });
  }

  criarGotasNaTela(intensidade) {
    this.gotasTela.innerHTML = '';
    this.gotasTela.classList.add('visivel');
    
    const numGotas = intensidade === 'leve' ? 20 : intensidade === 'forte' ? 50 : 80;
    
    for(let i = 0; i < numGotas; i++){
      const gota = document.createElement('div');
      gota.className = 'gota-tela';
      
      const tamanho = Math.random() * 8 + 4;
      const duracao = Math.random() * 3 + 2;
      const atraso = Math.random() * 5;
      
      gota.style.width = tamanho + 'px';
      gota.style.height = tamanho * 1.5 + 'px';
      gota.style.left = Math.random() * 100 + 'vw';
      gota.style.animationDuration = duracao + 's';
      gota.style.animationDelay = atraso + 's';
      
      this.gotasTela.appendChild(gota);
    }
  }

  createCloudy() {
    this.escurecerTela.classList.add('nublado');
    const nuvensDiv = document.getElementById('nuvens');
    nuvensDiv.style.display = 'block';
    
    for(let i = 0; i < 12; i++){
      const nuvem = document.createElement('div');
      nuvem.className = Math.random() > 0.6 ? 'nuvem grossa' : 'nuvem leve';
      nuvem.style.width = (200 + Math.random() * 300) + 'px';
      nuvem.style.height = (80 + Math.random() * 120) + 'px';
      nuvem.style.top = (i * 70 + Math.random() * 150) + 'px';
      nuvem.style.animationDuration = (60 + i * 10) + 's';
      nuvem.style.animationDelay = Math.random() * 20 + 's';
      nuvensDiv.appendChild(nuvem);
    }
  }

  createLightRain() {
    this.escurecerTela.classList.add('chuva-leve');
    this.mapaImg.classList.add('molhado');
    this.criarGotasNaTela('leve');
    
    const chuvaDiv = document.getElementById('chuva');
    chuvaDiv.style.display = 'block';
    for(let i = 0; i < 60; i++){
      const gota = document.createElement('div');
      gota.className = 'gota leve';
      gota.style.left = Math.random() * 100 + 'vw';
      gota.style.animationDuration = (1.5 + Math.random() * 1) + 's';
      gota.style.animationDelay = Math.random() * 4 + 's';
      chuvaDiv.appendChild(gota);
    }
    this.createCloudy();
  }

  createHeavyRain() {
    this.escurecerTela.classList.add('chuva-forte');
    this.mapaImg.classList.add('molhado-forte');
    this.criarGotasNaTela('forte');
    
    const chuvaDiv = document.getElementById('chuva');
    chuvaDiv.style.display = 'block';
    for(let i = 0; i < 150; i++){
      const gota = document.createElement('div');
      gota.className = 'gota forte';
      gota.style.left = Math.random() * 100 + 'vw';
      gota.style.animationDuration = (0.8 + Math.random() * 0.5) + 's';
      gota.style.animationDelay = Math.random() * 2 + 's';
      chuvaDiv.appendChild(gota);
    }
    this.createCloudy();
  }

  createStorm() {
    this.escurecerTela.classList.add('tempestade');
    this.mapaImg.classList.add('tempestade');
    this.criarGotasNaTela('tempestade');
    
    const chuvaDiv = document.getElementById('chuva');
    const tempestadeDiv = document.getElementById('tempestade');
    chuvaDiv.style.display = 'block';
    tempestadeDiv.style.display = 'block';
    
    for(let i = 0; i < 250; i++){
      const gota = document.createElement('div');
      gota.className = 'gota tempestade';
      gota.style.left = Math.random() * 100 + 'vw';
      gota.style.animationDuration = (0.5 + Math.random() * 0.4) + 's';
      gota.style.animationDelay = Math.random() * 1 + 's';
      chuvaDiv.appendChild(gota);
    }
    this.startLightning();
    this.createCloudy();
  }

  startLightning() {
    const criarRaio = () => {
      const raio = document.createElement('div');
      raio.className = 'raio';
      document.querySelector('.mapa-container').appendChild(raio);
      setTimeout(() => {
        if (raio.parentNode) raio.parentNode.removeChild(raio);
      }, 3000);
      const nextLightning = Math.random() * 5000 + 2000;
      setTimeout(criarRaio, nextLightning);
    };
    setTimeout(criarRaio, Math.random() * 3000 + 1000);
  }

  createSunny() {
    const solDiv = document.getElementById('sol');
    solDiv.style.display = 'block';
    const nuvensDiv = document.getElementById('nuvens');
    nuvensDiv.style.display = 'block';
    
    for(let i = 0; i < 6; i++){
      const nuvem = document.createElement('div');
      nuvem.className = 'nuvem leve';
      nuvem.style.width = (120 + Math.random() * 180) + 'px';
      nuvem.style.height = (50 + Math.random() * 80) + 'px';
      nuvem.style.top = (i * 100 + Math.random() * 100) + 'px';
      nuvem.style.animationDuration = (80 + i * 15) + 's';
      nuvem.style.animationDelay = Math.random() * 30 + 's';
      nuvensDiv.appendChild(nuvem);
    }
  }

  createSnow() {
    const neveDiv = document.getElementById('neve');
    neveDiv.style.display = 'block';
    
    for(let i = 0; i < 120; i++){
      const floco = document.createElement('div');
      floco.className = 'floco';
      const tamanho = 2 + Math.random() * 8;
      floco.style.width = tamanho + 'px';
      floco.style.height = tamanho + 'px';
      floco.style.left = Math.random() * 100 + 'vw';
      floco.style.animationDuration = (10 + Math.random() * 20) + 's';
      floco.style.animationDelay = Math.random() * 10 + 's';
      neveDiv.appendChild(floco);
    }
    this.escurecerTela.classList.add('nublado');
  }
}

class PositionManager {
  constructor() {
    this.storageKey = 'mapa-palotina-posicoes';
    this.loadPositions();
  }

  savePositions() {
    const positions = {};
    const menus = document.querySelectorAll('.menu');
    menus.forEach(menu => {
      const style = window.getComputedStyle(menu);
      positions[menu.id] = {
        left: parseFloat(style.left),
        top: parseFloat(style.top)
      };
    });
    localStorage.setItem(this.storageKey, JSON.stringify(positions));
    
    const btn = document.getElementById('salvarPosicoes');
    const originalText = btn.innerHTML;
    btn.innerHTML = '✓';
    btn.style.backgroundColor = 'rgba(46, 204, 113, 0.8)';
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.style.backgroundColor = '';
    }, 1000);
  }

  loadPositions() {
    const saved = localStorage.getItem(this.storageKey);
    if (saved) {
      try {
        const positions = JSON.parse(saved);
        Object.keys(positions).forEach(menuId => {
          const menu = document.getElementById(menuId);
          if (menu) {
            menu.style.left = positions[menuId].left + 'px';
            menu.style.top = positions[menuId].top + 'px';
          }
        });
      } catch (e) {
        console.error('Erro ao carregar posições:', e);
      }
    }
  }

  resetPositions() {
    localStorage.removeItem(this.storageKey);
    location.reload();
  }
}

class ShareSystem {
  constructor() {
    this.modal = document.getElementById('shareModal');
    this.shareUrl = document.getElementById('shareUrl');
    this.init();
  }

  init() {
    document.getElementById('shareBtn').addEventListener('click', () => {
      this.openShareModal();
    });
  }

  openShareModal() {
    this.shareUrl.value = window.location.href;
    this.modal.style.display = 'flex';
  }

  closeShareModal() {
    this.modal.style.display = 'none';
  }

  shareWhatsApp() {
    const text = 'Confira este Mapa Interativo de Palotina em Tempo Real!';
    const url = `https://wa.me/?text=${encodeURIComponent(text + ' ' + window.location.href)}`;
    window.open(url, '_blank');
  }

  shareEmail() {
    const subject = 'Mapa Interativo de Palotina - Tempo Real';
    const body = `Confira este mapa interativo em tempo real: ${window.location.href}`;
    const url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = url;
  }

  shareLink() {
    const url = window.location.href;
    const text = 'Mapa Interativo de Palotina - Tempo Real';
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
  }

  copyLink() {
    this.shareUrl.select();
    document.execCommand('copy');
    const copyBtn = document.querySelector('.share-btn.copy');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = '✓ Copiado!';
    copyBtn.style.background = '#27ae60';
    setTimeout(() => {
      copyBtn.textContent = originalText;
      copyBtn.style.background = '';
    }, 2000);
  }
}

// ========== CONFIGURAÇÕES E INICIALIZAÇÃO ==========
const apiKey = '41fb4952fe6e7e459742c89963adb9e3';
const cidade = 'Palotina,BR';

// Inicializar sistemas
let webSocketSystem;
let dragSystem;
let positionManager;
let weatherEffects;
let cicloDiaNoite;
let bolinhasSystem;
let shareSystem;

// Função para obter dados do clima
async function obterClima() {
  try {
    const resposta = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cidade}&appid=${apiKey}&units=metric&lang=pt_br`);
    if (!resposta.ok) throw new Error('Erro na resposta da API');
    
    const dados = await resposta.json();
    const temperatura = dados.main.temp;
    const descricao = dados.weather[0].description;
    const condicao = dados.weather[0].main.toLowerCase();
    const intensidade = dados.weather[0].id;

    document.getElementById('temperatura').textContent = `${temperatura.toFixed(1)}°C`;
    document.getElementById('condicao').textContent = descricao.charAt(0).toUpperCase() + descricao.slice(1);

    atualizarAnimacoes(condicao, intensidade);
  } catch (erro) {
    console.error('Erro ao obter dados climáticos:', erro);
    document.getElementById('temperatura').textContent = '--°C';
    document.getElementById('condicao').textContent = 'Dados indisponíveis';
  }
}

// Função para atualizar animações climáticas
function atualizarAnimacoes(condicao, intensidade){
  weatherEffects.clearEffects();

  let efeitoChuva = 'leve';
  if (intensidade >= 500 && intensidade <= 504) {
    efeitoChuva = 'leve';
  } else if (intensidade >= 520 && intensidade <= 531) {
    efeitoChuva = 'forte';
  } else if (intensidade >= 200 && intensidade <= 232) {
    efeitoChuva = 'tempestade';
  }

  if(condicao.includes('thunderstorm') || intensidade >= 200 && intensidade <= 232){
    weatherEffects.createStorm();
  } else if(condicao.includes('rain') || condicao.includes('drizzle')){
    if(efeitoChuva === 'forte') {
      weatherEffects.createHeavyRain();
    } else {
      weatherEffects.createLightRain();
    }
  } else if(condicao.includes('snow')){
    weatherEffects.createSnow();
  } else if(condicao.includes('cloud')){
    weatherEffects.createCloudy();
  } else if(condicao.includes('clear') || condicao.includes('sun')){
    weatherEffects.createSunny();
  }
}

// Função para atualizar data e hora
function atualizarDataHora(){
  const agora = new Date();
  const dia = String(agora.getDate()).padStart(2,'0');
  const mes = String(agora.getMonth()+1).padStart(2,'0');
  const ano = String(agora.getFullYear()).slice(-2);
  const horas = String(agora.getHours()).padStart(2,'0');
  const minutos = String(agora.getMinutes()).padStart(2,'0');
  document.getElementById('data').textContent = `${dia}/${mes}/${ano}`;
  document.getElementById('hora').textContent = `${horas}:${minutos}`;
}

// Inicialização quando o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar sistemas
  webSocketSystem = new WebSocketSystem();
  dragSystem = new DragSystem();
  positionManager = new PositionManager();
  weatherEffects = new WeatherEffects();
  cicloDiaNoite = new CicloDiaNoite();
  bolinhasSystem = new BolinhasSystem();
  shareSystem = new ShareSystem();
  
  // Atualizar data/hora a cada segundo
  setInterval(atualizarDataHora, 1000);
  atualizarDataHora();
  
  // Obter dados do clima
  obterClima();
  
  // Configurar eventos dos menus
  const menus = document.querySelectorAll('.menu');
  menus.forEach(menu => {
    menu.addEventListener('click', function(e) {
      if (!dragSystem.dragging) {
        const estaAtivo = this.classList.contains('ativo');
        menus.forEach(m => {
          m.classList.remove('ativo');
          m.setAttribute('aria-expanded', 'false');
        });
        if (!estaAtivo) {
          this.classList.add('ativo');
          this.setAttribute('aria-expanded', 'true');
        }
      }
    });
  });
  
  // Configurar botões
  document.getElementById('darkMode').addEventListener('click', function() {
    document.body.classList.toggle('dark-mode');
    this.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
  });
  
  document.getElementById('refresh').addEventListener('click', function() {
    obterClima();
    this.style.animation = 'spin 0.5s linear';
    setTimeout(() => {
      this.style.animation = '';
    }, 500);
  });
  
  document.getElementById('salvarPosicoes').addEventListener('click', function() {
    positionManager.savePositions();
  });
  
  document.getElementById('resetPosicoes').addEventListener('click', function() {
    if (confirm('Deseja resetar todas as posições dos menus para as posições originais?')) {
      positionManager.resetPositions();
    }
  });
  
  // Configurar F11 para tela cheia
  document.addEventListener('keydown', function(e) {
    if(e.key === 'F11') {
      e.preventDefault();
      const aviso = document.querySelector('.aviso');
      if(aviso) aviso.style.display = 'none';
      if(!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Erro ao tentar entrar em tela cheia: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    }
  });
  
  // Fechar menus ao clicar fora
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.menu')) {
      menus.forEach(menu => {
        menu.classList.remove('ativo');
        menu.setAttribute('aria-expanded', 'false');
      });
    }
  });

  // Fechar modal ao clicar fora
  document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
      shareSystem.closeShareModal();
    }
  });

  // Simular contador de usuários (em produção isso viria do servidor)
  setInterval(() => {
    if (webSocketSystem.conectado) {
      // Contador real virá do WebSocket
    } else {
      // Contador simulado quando offline
      const contador = 1;
      document.getElementById('contadorUsuarios').textContent = contador;
      document.getElementById('contadorOnline').textContent = contador;
    }
  }, 5000);
});

// Funções globais para o modal de compartilhamento
function closeShareModal() {
  shareSystem.closeShareModal();
}

function shareWhatsApp() {
  shareSystem.shareWhatsApp();
}

function shareEmail() {
  shareSystem.shareEmail();
}

function shareLink() {
  shareSystem.shareLink();
}

function copyLink() {
  shareSystem.copyLink();
}

// Adicionar animação de spin
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// Log de inicialização
console.log(`🗺️ Mapa Interativo Palotina v${VERSAO}`);
console.log(`🔗 WebSocket Server: ${WS_SERVER}`);
console.log('👥 Suporte para até 15 usuários simultâneos');
console.log('🚀 Sistemas inicializados com sucesso');
</script>

</body>
</html>